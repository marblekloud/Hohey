{"ast":null,"code":"'use strict';\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _events = _interopRequireDefault(require(\"events\"));\n\nvar POPUP = _interopRequireWildcard(require(\"../constants/popup\"));\n\nvar ERROR = _interopRequireWildcard(require(\"../constants/errors\"));\n\nvar _showPopupRequest = require(\"./showPopupRequest\");\n\nvar _networkUtils = require(\"../utils/networkUtils\");\n\nvar _deferred = require(\"../utils/deferred\"); // const POPUP_REQUEST_TIMEOUT: number = 602;\n\n\nvar POPUP_REQUEST_TIMEOUT = 850;\nvar POPUP_CLOSE_INTERVAL = 500;\nvar POPUP_OPEN_TIMEOUT = 2000;\n\nvar PopupManager = /*#__PURE__*/function (_EventEmitter) {\n  (0, _inheritsLoose2[\"default\"])(PopupManager, _EventEmitter); // Window\n\n  function PopupManager(settings) {\n    var _this;\n\n    _this = _EventEmitter.call(this) || this;\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"requestTimeout\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"closeInterval\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"extension\", false);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"extensionTabId\", 0);\n    _this.settings = settings;\n    _this.src = settings.popupSrc;\n    _this.origin = (0, _networkUtils.getOrigin)(settings.popupSrc);\n    _this.handleLazyLoading = _this.handleLazyLoading.bind((0, _assertThisInitialized2[\"default\"])(_this)); // $FlowIssue chrome not declared outside\n\n    _this.extension = typeof chrome !== 'undefined' && chrome.runtime && typeof chrome.runtime.onConnect !== 'undefined';\n\n    if (_this.extension) {\n      _this.handleExtensionConnect = _this.handleExtensionConnect.bind((0, _assertThisInitialized2[\"default\"])(_this));\n      _this.handleExtensionMessage = _this.handleExtensionMessage.bind((0, _assertThisInitialized2[\"default\"])(_this)); // $FlowIssue chrome not declared outside\n\n      chrome.runtime.onConnect.addListener(_this.handleExtensionConnect);\n    }\n\n    return _this;\n  }\n\n  var _proto = PopupManager.prototype;\n\n  _proto.request = function request(lazyLoad) {\n    var _this2 = this;\n\n    if (lazyLoad === void 0) {\n      lazyLoad = false;\n    } // popup request\n    // TODO: ie - open imediately and hide it but post handshake after timeout\n    // bring popup window to front\n\n\n    if (this.locked) {\n      if (this._window) {\n        if (this.extension) {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.update(this._window.id, {\n            active: true\n          });\n        } else {\n          this._window.focus();\n        }\n      }\n\n      return;\n    }\n\n    this.lazyLoad = lazyLoad ? (0, _deferred.create)(POPUP.INIT) : null;\n\n    if (this.lazyLoad) {\n      if (!this.extension) {\n        window.addEventListener('message', this.handleLazyLoading, false);\n      }\n    }\n\n    var openFn = this.open.bind(this);\n    this.locked = true;\n\n    if (!this.settings.supportedBrowser) {\n      openFn();\n    } else {\n      this.requestTimeout = window.setTimeout(function () {\n        _this2.requestTimeout = 0;\n        openFn();\n      }, lazyLoad || this.extension ? 1 : POPUP_REQUEST_TIMEOUT);\n    }\n  };\n\n  _proto.cancel = function cancel() {\n    this.close();\n  };\n\n  _proto.unlock = function unlock() {\n    this.locked = false;\n  };\n\n  _proto.open = function open() {\n    var _this3 = this;\n\n    if (!this.settings.supportedBrowser) {\n      this.openWrapper(this.src + '#unsupported');\n      return;\n    }\n\n    this.openWrapper(this.lazyLoad ? this.src + '#loading' : this.src);\n    this.closeInterval = window.setInterval(function () {\n      if (_this3._window) {\n        if (_this3.extension) {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.get(_this3._window.id, function (tab) {\n            if (!tab) {\n              _this3.close();\n\n              _this3.emit(POPUP.CLOSED);\n            }\n          });\n        } else if (_this3._window.closed) {\n          _this3.close();\n\n          _this3.emit(POPUP.CLOSED);\n        }\n      }\n    }, POPUP_CLOSE_INTERVAL);\n    this.openTimeout = window.setTimeout(function () {\n      if (!(_this3._window && !_this3._window.closed)) {\n        _this3.close();\n\n        (0, _showPopupRequest.showPopupRequest)(_this3.open.bind(_this3), function () {\n          _this3.emit(POPUP.CLOSED);\n        });\n      }\n    }, POPUP_OPEN_TIMEOUT);\n  };\n\n  _proto.openWrapper = function openWrapper(url) {\n    var _this4 = this;\n\n    if (this.extension) {\n      // $FlowIssue chrome not declared outside\n      chrome.windows.getCurrent(null, function (currentWindow) {\n        // Request coming from extension popup,\n        // create new window above instead of opening new tab\n        if (currentWindow.type !== 'normal') {\n          // $FlowIssue chrome not declared outside\n          chrome.windows.create({\n            url: url\n          }, function (newWindow) {\n            // $FlowIssue chrome not declared outside\n            chrome.tabs.query({\n              windowId: newWindow.id,\n              active: true\n            }, function (tabs) {\n              _this4._window = tabs[0];\n            });\n          });\n        } else {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.query({\n            currentWindow: true,\n            active: true\n          }, function (tabs) {\n            _this4.extensionTabId = tabs[0].id; // $FlowIssue chrome not declared outside\n\n            chrome.tabs.create({\n              url: url,\n              index: tabs[0].index + 1\n            }, function (tab) {\n              _this4._window = tab;\n            });\n          });\n        }\n      });\n    } else {\n      this._window = window.open('', '_blank');\n\n      if (this._window) {\n        this._window.location.href = url; // otherwise android/chrome loose window.opener reference\n      }\n    }\n  };\n\n  _proto.handleExtensionConnect = function handleExtensionConnect(port) {\n    if (port.name === 'trezor-connect') {\n      if (!this._window || this._window && this._window.id !== port.sender.tab.id) {\n        port.disconnect();\n        return;\n      }\n\n      this.extensionPort = port; // $FlowIssue need to update ChromePort definition\n\n      this.extensionPort.onMessage.addListener(this.handleExtensionMessage);\n    } else if (port.name === 'trezor-usb-permissions') {\n      port.postMessage({\n        broadcast: this.broadcast\n      });\n    }\n  };\n\n  _proto.handleExtensionMessage = function handleExtensionMessage(message) {\n    if (!this.extensionPort) return;\n\n    if (message === POPUP.EXTENSION_REQUEST) {\n      this.extensionPort.postMessage({\n        type: POPUP.EXTENSION_REQUEST,\n        broadcast: this.broadcast\n      });\n    } else if (message === POPUP.INIT && this.lazyLoad) {\n      this.lazyLoad.resolve(true);\n    } else if (message === POPUP.EXTENSION_USB_PERMISSIONS) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.query({\n        currentWindow: true,\n        active: true\n      }, function (tabs) {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.create({\n          url: 'trezor-usb-permissions.html',\n          index: tabs[0].index + 1\n        }, function (tab) {// do nothing\n        });\n      });\n    } else if (message === POPUP.CLOSE_WINDOW) {\n      this.emit(POPUP.CLOSED);\n      this.close();\n    }\n  };\n\n  _proto.setBroadcast = function setBroadcast(broadcast) {\n    this.broadcast = broadcast;\n  };\n\n  _proto.handleLazyLoading = function handleLazyLoading(event) {\n    if (this.lazyLoad && event.data && event.data === POPUP.INIT) {\n      this.lazyLoad.resolve(true);\n      window.removeEventListener('message', this.handleLazyLoading, false);\n    }\n  };\n\n  _proto.resolveLazyLoad = /*#__PURE__*/function () {\n    var _resolveLazyLoad = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee() {\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!this.lazyLoad) {\n                _context.next = 5;\n                break;\n              }\n\n              _context.next = 3;\n              return this.lazyLoad.promise;\n\n            case 3:\n              _context.next = 6;\n              break;\n\n            case 5:\n              throw ERROR.POPUP_CLOSED.message;\n\n            case 6:\n              if (this.extension) {\n                if (this.extensionPort) {\n                  this.extensionPort.postMessage({\n                    type: POPUP.INIT\n                  });\n                }\n              } else if (this._window) {\n                this._window.postMessage({\n                  type: POPUP.INIT\n                }, this.origin);\n              }\n\n            case 7:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, this);\n    }));\n\n    function resolveLazyLoad() {\n      return _resolveLazyLoad.apply(this, arguments);\n    }\n\n    return resolveLazyLoad;\n  }();\n\n  _proto.close = function close() {\n    this.locked = false;\n\n    if (this.requestTimeout) {\n      window.clearTimeout(this.requestTimeout);\n      this.requestTimeout = 0;\n    }\n\n    if (this.openTimeout) {\n      window.clearTimeout(this.openTimeout);\n      this.openTimeout = 0;\n    }\n\n    if (this.closeInterval) {\n      window.clearInterval(this.closeInterval);\n      this.closeInterval = 0;\n    }\n\n    if (this.extensionPort) {\n      this.extensionPort.disconnect();\n      this.extensionPort = null;\n    }\n\n    if (this.extensionTabId) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.update(this.extensionTabId, {\n        active: true\n      });\n      this.extensionTabId = 0;\n    }\n\n    if (this.lazyLoad) {\n      this.lazyLoad = null;\n    }\n\n    if (this._window) {\n      if (this.extension) {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.remove(this._window.id);\n      } else {\n        this._window.close();\n      }\n\n      this._window = null;\n    }\n  };\n\n  _proto.postMessage = function postMessage(message) {\n    var _this5 = this; // post message before popup request finalized\n\n\n    if (this.requestTimeout) {\n      return;\n    } // device needs interaction but there is no popup/ui\n    // maybe popup request wasn't handled\n    // ignore \"ui_request_window\" type\n\n\n    if (!this._window && message.type !== 'ui_request_window' && this.openTimeout) {\n      this.close();\n      (0, _showPopupRequest.showPopupRequest)(this.open.bind(this), function () {\n        _this5.emit(POPUP.CLOSED);\n      });\n      return;\n    } // post message to popup window\n\n\n    if (this._window) {\n      this._window.postMessage(message, this.origin);\n    }\n  };\n\n  _proto.onBeforeUnload = function onBeforeUnload() {\n    this.close();\n  };\n\n  _proto.cancelOpenTimeout = function cancelOpenTimeout() {\n    window.clearTimeout(this.openTimeout);\n  };\n\n  return PopupManager;\n}(_events[\"default\"]);\n\nexports[\"default\"] = PopupManager;","map":{"version":3,"sources":["/Users/kelvinho/Documents/Coding/HoHey-main 4 2/hoheywebsite/client/src/example/node_modules/trezor-connect/lib/popup/PopupManager.js"],"names":["_interopRequireWildcard","require","_interopRequireDefault","exports","__esModule","_regenerator","_asyncToGenerator2","_assertThisInitialized2","_inheritsLoose2","_defineProperty2","_events","POPUP","ERROR","_showPopupRequest","_networkUtils","_deferred","POPUP_REQUEST_TIMEOUT","POPUP_CLOSE_INTERVAL","POPUP_OPEN_TIMEOUT","PopupManager","_EventEmitter","settings","_this","call","src","popupSrc","origin","getOrigin","handleLazyLoading","bind","extension","chrome","runtime","onConnect","handleExtensionConnect","handleExtensionMessage","addListener","_proto","prototype","request","lazyLoad","_this2","locked","_window","tabs","update","id","active","focus","create","INIT","window","addEventListener","openFn","open","supportedBrowser","requestTimeout","setTimeout","cancel","close","unlock","_this3","openWrapper","closeInterval","setInterval","get","tab","emit","CLOSED","closed","openTimeout","showPopupRequest","url","_this4","windows","getCurrent","currentWindow","type","newWindow","query","windowId","extensionTabId","index","location","href","port","name","sender","disconnect","extensionPort","onMessage","postMessage","broadcast","message","EXTENSION_REQUEST","resolve","EXTENSION_USB_PERMISSIONS","CLOSE_WINDOW","setBroadcast","event","data","removeEventListener","resolveLazyLoad","_resolveLazyLoad","mark","_callee","wrap","_callee$","_context","prev","next","promise","POPUP_CLOSED","stop","apply","arguments","clearTimeout","clearInterval","remove","_this5","onBeforeUnload","cancelOpenTimeout"],"mappings":"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","sourcesContent":["'use strict';\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _events = _interopRequireDefault(require(\"events\"));\n\nvar POPUP = _interopRequireWildcard(require(\"../constants/popup\"));\n\nvar ERROR = _interopRequireWildcard(require(\"../constants/errors\"));\n\nvar _showPopupRequest = require(\"./showPopupRequest\");\n\nvar _networkUtils = require(\"../utils/networkUtils\");\n\nvar _deferred = require(\"../utils/deferred\");\n\n// const POPUP_REQUEST_TIMEOUT: number = 602;\nvar POPUP_REQUEST_TIMEOUT = 850;\nvar POPUP_CLOSE_INTERVAL = 500;\nvar POPUP_OPEN_TIMEOUT = 2000;\n\nvar PopupManager =\n/*#__PURE__*/\nfunction (_EventEmitter) {\n  (0, _inheritsLoose2[\"default\"])(PopupManager, _EventEmitter);\n\n  // Window\n  function PopupManager(settings) {\n    var _this;\n\n    _this = _EventEmitter.call(this) || this;\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"requestTimeout\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"closeInterval\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"extension\", false);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"extensionTabId\", 0);\n    _this.settings = settings;\n    _this.src = settings.popupSrc;\n    _this.origin = (0, _networkUtils.getOrigin)(settings.popupSrc);\n    _this.handleLazyLoading = _this.handleLazyLoading.bind((0, _assertThisInitialized2[\"default\"])(_this)); // $FlowIssue chrome not declared outside\n\n    _this.extension = typeof chrome !== 'undefined' && chrome.runtime && typeof chrome.runtime.onConnect !== 'undefined';\n\n    if (_this.extension) {\n      _this.handleExtensionConnect = _this.handleExtensionConnect.bind((0, _assertThisInitialized2[\"default\"])(_this));\n      _this.handleExtensionMessage = _this.handleExtensionMessage.bind((0, _assertThisInitialized2[\"default\"])(_this)); // $FlowIssue chrome not declared outside\n\n      chrome.runtime.onConnect.addListener(_this.handleExtensionConnect);\n    }\n\n    return _this;\n  }\n\n  var _proto = PopupManager.prototype;\n\n  _proto.request = function request(lazyLoad) {\n    var _this2 = this;\n\n    if (lazyLoad === void 0) {\n      lazyLoad = false;\n    }\n\n    // popup request\n    // TODO: ie - open imediately and hide it but post handshake after timeout\n    // bring popup window to front\n    if (this.locked) {\n      if (this._window) {\n        if (this.extension) {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.update(this._window.id, {\n            active: true\n          });\n        } else {\n          this._window.focus();\n        }\n      }\n\n      return;\n    }\n\n    this.lazyLoad = lazyLoad ? (0, _deferred.create)(POPUP.INIT) : null;\n\n    if (this.lazyLoad) {\n      if (!this.extension) {\n        window.addEventListener('message', this.handleLazyLoading, false);\n      }\n    }\n\n    var openFn = this.open.bind(this);\n    this.locked = true;\n\n    if (!this.settings.supportedBrowser) {\n      openFn();\n    } else {\n      this.requestTimeout = window.setTimeout(function () {\n        _this2.requestTimeout = 0;\n        openFn();\n      }, lazyLoad || this.extension ? 1 : POPUP_REQUEST_TIMEOUT);\n    }\n  };\n\n  _proto.cancel = function cancel() {\n    this.close();\n  };\n\n  _proto.unlock = function unlock() {\n    this.locked = false;\n  };\n\n  _proto.open = function open() {\n    var _this3 = this;\n\n    if (!this.settings.supportedBrowser) {\n      this.openWrapper(this.src + '#unsupported');\n      return;\n    }\n\n    this.openWrapper(this.lazyLoad ? this.src + '#loading' : this.src);\n    this.closeInterval = window.setInterval(function () {\n      if (_this3._window) {\n        if (_this3.extension) {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.get(_this3._window.id, function (tab) {\n            if (!tab) {\n              _this3.close();\n\n              _this3.emit(POPUP.CLOSED);\n            }\n          });\n        } else if (_this3._window.closed) {\n          _this3.close();\n\n          _this3.emit(POPUP.CLOSED);\n        }\n      }\n    }, POPUP_CLOSE_INTERVAL);\n    this.openTimeout = window.setTimeout(function () {\n      if (!(_this3._window && !_this3._window.closed)) {\n        _this3.close();\n\n        (0, _showPopupRequest.showPopupRequest)(_this3.open.bind(_this3), function () {\n          _this3.emit(POPUP.CLOSED);\n        });\n      }\n    }, POPUP_OPEN_TIMEOUT);\n  };\n\n  _proto.openWrapper = function openWrapper(url) {\n    var _this4 = this;\n\n    if (this.extension) {\n      // $FlowIssue chrome not declared outside\n      chrome.windows.getCurrent(null, function (currentWindow) {\n        // Request coming from extension popup,\n        // create new window above instead of opening new tab\n        if (currentWindow.type !== 'normal') {\n          // $FlowIssue chrome not declared outside\n          chrome.windows.create({\n            url: url\n          }, function (newWindow) {\n            // $FlowIssue chrome not declared outside\n            chrome.tabs.query({\n              windowId: newWindow.id,\n              active: true\n            }, function (tabs) {\n              _this4._window = tabs[0];\n            });\n          });\n        } else {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.query({\n            currentWindow: true,\n            active: true\n          }, function (tabs) {\n            _this4.extensionTabId = tabs[0].id; // $FlowIssue chrome not declared outside\n\n            chrome.tabs.create({\n              url: url,\n              index: tabs[0].index + 1\n            }, function (tab) {\n              _this4._window = tab;\n            });\n          });\n        }\n      });\n    } else {\n      this._window = window.open('', '_blank');\n\n      if (this._window) {\n        this._window.location.href = url; // otherwise android/chrome loose window.opener reference\n      }\n    }\n  };\n\n  _proto.handleExtensionConnect = function handleExtensionConnect(port) {\n    if (port.name === 'trezor-connect') {\n      if (!this._window || this._window && this._window.id !== port.sender.tab.id) {\n        port.disconnect();\n        return;\n      }\n\n      this.extensionPort = port; // $FlowIssue need to update ChromePort definition\n\n      this.extensionPort.onMessage.addListener(this.handleExtensionMessage);\n    } else if (port.name === 'trezor-usb-permissions') {\n      port.postMessage({\n        broadcast: this.broadcast\n      });\n    }\n  };\n\n  _proto.handleExtensionMessage = function handleExtensionMessage(message) {\n    if (!this.extensionPort) return;\n\n    if (message === POPUP.EXTENSION_REQUEST) {\n      this.extensionPort.postMessage({\n        type: POPUP.EXTENSION_REQUEST,\n        broadcast: this.broadcast\n      });\n    } else if (message === POPUP.INIT && this.lazyLoad) {\n      this.lazyLoad.resolve(true);\n    } else if (message === POPUP.EXTENSION_USB_PERMISSIONS) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.query({\n        currentWindow: true,\n        active: true\n      }, function (tabs) {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.create({\n          url: 'trezor-usb-permissions.html',\n          index: tabs[0].index + 1\n        }, function (tab) {// do nothing\n        });\n      });\n    } else if (message === POPUP.CLOSE_WINDOW) {\n      this.emit(POPUP.CLOSED);\n      this.close();\n    }\n  };\n\n  _proto.setBroadcast = function setBroadcast(broadcast) {\n    this.broadcast = broadcast;\n  };\n\n  _proto.handleLazyLoading = function handleLazyLoading(event) {\n    if (this.lazyLoad && event.data && event.data === POPUP.INIT) {\n      this.lazyLoad.resolve(true);\n      window.removeEventListener('message', this.handleLazyLoading, false);\n    }\n  };\n\n  _proto.resolveLazyLoad =\n  /*#__PURE__*/\n  function () {\n    var _resolveLazyLoad = (0, _asyncToGenerator2[\"default\"])(\n    /*#__PURE__*/\n    _regenerator[\"default\"].mark(function _callee() {\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!this.lazyLoad) {\n                _context.next = 5;\n                break;\n              }\n\n              _context.next = 3;\n              return this.lazyLoad.promise;\n\n            case 3:\n              _context.next = 6;\n              break;\n\n            case 5:\n              throw ERROR.POPUP_CLOSED.message;\n\n            case 6:\n              if (this.extension) {\n                if (this.extensionPort) {\n                  this.extensionPort.postMessage({\n                    type: POPUP.INIT\n                  });\n                }\n              } else if (this._window) {\n                this._window.postMessage({\n                  type: POPUP.INIT\n                }, this.origin);\n              }\n\n            case 7:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, this);\n    }));\n\n    function resolveLazyLoad() {\n      return _resolveLazyLoad.apply(this, arguments);\n    }\n\n    return resolveLazyLoad;\n  }();\n\n  _proto.close = function close() {\n    this.locked = false;\n\n    if (this.requestTimeout) {\n      window.clearTimeout(this.requestTimeout);\n      this.requestTimeout = 0;\n    }\n\n    if (this.openTimeout) {\n      window.clearTimeout(this.openTimeout);\n      this.openTimeout = 0;\n    }\n\n    if (this.closeInterval) {\n      window.clearInterval(this.closeInterval);\n      this.closeInterval = 0;\n    }\n\n    if (this.extensionPort) {\n      this.extensionPort.disconnect();\n      this.extensionPort = null;\n    }\n\n    if (this.extensionTabId) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.update(this.extensionTabId, {\n        active: true\n      });\n      this.extensionTabId = 0;\n    }\n\n    if (this.lazyLoad) {\n      this.lazyLoad = null;\n    }\n\n    if (this._window) {\n      if (this.extension) {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.remove(this._window.id);\n      } else {\n        this._window.close();\n      }\n\n      this._window = null;\n    }\n  };\n\n  _proto.postMessage = function postMessage(message) {\n    var _this5 = this;\n\n    // post message before popup request finalized\n    if (this.requestTimeout) {\n      return;\n    } // device needs interaction but there is no popup/ui\n    // maybe popup request wasn't handled\n    // ignore \"ui_request_window\" type\n\n\n    if (!this._window && message.type !== 'ui_request_window' && this.openTimeout) {\n      this.close();\n      (0, _showPopupRequest.showPopupRequest)(this.open.bind(this), function () {\n        _this5.emit(POPUP.CLOSED);\n      });\n      return;\n    } // post message to popup window\n\n\n    if (this._window) {\n      this._window.postMessage(message, this.origin);\n    }\n  };\n\n  _proto.onBeforeUnload = function onBeforeUnload() {\n    this.close();\n  };\n\n  _proto.cancelOpenTimeout = function cancelOpenTimeout() {\n    window.clearTimeout(this.openTimeout);\n  };\n\n  return PopupManager;\n}(_events[\"default\"]);\n\nexports[\"default\"] = PopupManager;"]},"metadata":{},"sourceType":"module"}